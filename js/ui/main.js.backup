/**
 * Speaker Design Tool v3 - Main Application Entry
 * Full Physics Implementation (Ported from v2.6.3)
 */

(function () {
    const { createApp, reactive, computed, onMounted } = Vue;

    window.App.State = reactive({
        mode: 'low-z',
        qualityMode: 'average',
        projectInfo: {
            name: 'Untitled Project',
            date: new Date().toISOString().split('T')[0]
        },
        reportInfo: {
            company: '',
            designer: ''
        },
        settings: {
            temp_c: 20
        },
        database: window.App.Core.Database.DATA,
        lowZRoots: [],
        highVRoots: []
    });

    // Helper: Complex number addition
    const cAdd = (a, b) => {
        return new window.App.Core.Physics.ComplexNumber(a.real + b.real, a.imaginary + b.imaginary);
    }
    return false;
};

deleteFrom(window.App.State.lowZRoots, nodeId);
deleteFrom(window.App.State.highVRoots, nodeId);
this.calculateAll();
        },

calculateAll() {
    const state = window.App.State;
    const db = state.database;
    const physics = new window.App.Core.Physics.AudioPhysics({ base_temperature_c: state.settings.temp_c });
    const profile = window.App.Core.Database.PROFILES[state.qualityMode];
    const limits = {
        lowz_vd_warn: profile.maxDrop,
        lowz_vd_err: profile.maxDrop * 1.5,
        highv_vd_warn: profile.maxDrop,
        highv_vd_err: profile.maxDrop * 1.5,
        df_warn: 20,
        df_err: 10,
        headroom_warn: 0.80,
        hf_check_freq: 10000
    };

    // Helper: Get effective impedance of node + children
    const getEffectiveImpedance = (node, useMin = true) => {
        const speaker = db.speakers[node.speakerId];
        if (!speaker) return new window.App.Core.Physics.ComplexNumber(999999, 0);

        const parallel = node.parallelCount || 1;
        const zSpeaker = new window.App.Core.Physics.ComplexNumber(
            useMin ? (speaker.z_min || speaker.impedance) / parallel : speaker.impedance / parallel,
            0
        );

        if (!node.children || node.children.length === 0) return zSpeaker;

        // Parallel combination of children
        const childImpedances = node.children.map(c => getEffectiveImpedance(c, useMin));
        const parallelZ = childImpedances.reduce((acc, z) => {
            const combinedReal = 1 / ((1 / acc.real) + (1 / z.real));
            return new window.App.Core.Physics.ComplexNumber(combinedReal, 0);
        }, new window.App.Core.Physics.ComplexNumber(999999, 0));

        // Speaker || Children
        const combined = new window.App.Core.Physics.ComplexNumber(
            1 / ((1 / zSpeaker.real) + (1 / parallelZ.real)),
            0
        );
        return combined;
    };

    // Helper: Get total RMS power
    const getTotalRMS = (node) => {
        const speaker = db.speakers[node.speakerId];
        const parallel = node.parallelCount || 1;
        let power = speaker ? (speaker.wattage_rms || 0) * parallel : 0;
        if (node.children) {
            node.children.forEach(c => power += getTotalRMS(c));
        }
        return power;
    };

    // Helper: Get total 100V power
    const getTotalPower = (node) => {
        let p = node.tapPower || 0;
        if (node.children) {
            node.children.forEach(c => p += getTotalPower(c));
        }
        return p;
    };

    // Low-Z Branch Calculation
    const calcLowZ = (node, parentVolts = null, parentCumulativeR = 0, rootSourceVoltage = null, rootAmpModel = null) => {
        const speaker = db.speakers[node.speakerId];
        const cable = db.cables[node.cableId];

        if (!speaker || !cable) {
            node.results = {
                minLoad: null,
                nomLoad: null,
                dropPercent: null,
                powerLoss: null,
                splLoss: null,
                totalDF: null,
                hfLoss: null,
                status: !speaker ? 'Error' : 'Error',
                statusMessage: !speaker ? 'Speaker Missing' : 'Cable Missing'
            };
            return;
        }

        let sourceVoltage = parentVolts;
        let ampZ = 0;
        let currentRootVoltage = rootSourceVoltage;
        let currentRootAmp = rootAmpModel;

        const useBridge = node.useBridgeMode || false;
        const parallel = node.parallelCount || 1;

        if (!node.parentId) {
            const rootAmp = db.amplifiers[node.ampId];
            if (rootAmp) {
                const power = useBridge ? (rootAmp.watt_bridge_8 || 0) : rootAmp.watt_8;
                sourceVoltage = Math.sqrt(power * 8);
                currentRootVoltage = sourceVoltage;
                currentRootAmp = rootAmp;
                ampZ = 8 / (rootAmp.df || 100);
            }
        }

        const safeVolts = sourceVoltage || 100;
        const safeRootVolts = currentRootVoltage || safeVolts;

        const zMain = physics.getCableImpedance(cable, node.length, 1000, state.settings.temp_c);
        let zTotalCable = zMain;

        if (node.cable2Id && node.length2 > 0) {
            const cable2 = db.cables[node.cable2Id];
            if (cable2) {
                zTotalCable = cAdd(zTotalCable, physics.getCableImpedance(cable2, node.length2, 1000, state.settings.temp_c));
            }
        }

        const zEffectiveMin = getEffectiveImpedance(node, true);
        const zEffectiveNom = getEffectiveImpedance(node, false);
        const zMinMagnitude = cMag(zEffectiveMin);

        const tx = physics.calculateTransmission(safeVolts, zMinMagnitude, zTotalCable);
        const totalDropPercent = safeRootVolts > 0 ? ((safeRootVolts - tx.voltageAtLoad) / safeRootVolts) * 100 : 0;

        const electricalLossDb = physics.calculateElectricalSPLLoss(tx.voltageAtLoad, safeRootVolts);
        const cumulativeR = parentCumulativeR + tx.cableResistance;
        const zSpeakerNom = speaker.impedance / parallel;
        const totalDF = physics.calculateDampingFactor(zSpeakerNom, ampZ, cumulativeR);
        const hfCheck = physics.calculateHFLoss(safeVolts, zMinMagnitude, cable, node.length, state.settings.temp_c);

        let status = 'OK';
        let statusMsg = '';

        if (totalDropPercent > limits.lowz_vd_warn) { status = 'Warning'; statusMsg = 'High VD'; }
        if (totalDF < limits.df_warn && status !== 'Error') { status = 'Warning'; statusMsg = 'Low DF'; }
        if (totalDropPercent > limits.lowz_vd_err) { status = 'Error'; statusMsg = 'Critical VD'; }
        if (totalDF < limits.df_err) { status = 'Error'; statusMsg = 'Critical DF'; }

        // Headroom check
        if (currentRootAmp && !node.parentId) {
            const totalWatts = getTotalRMS(node);
            let ampCapacity = currentRootAmp.watt_8;
            const systemNominalZ = cMag(cAdd(zEffectiveNom, zTotalCable));

            if (useBridge) {
                if (systemNominalZ < 6 && currentRootAmp.watt_bridge_4) ampCapacity = currentRootAmp.watt_bridge_4;
                else if (currentRootAmp.watt_bridge_8) ampCapacity = currentRootAmp.watt_bridge_8;
            } else {
                if (systemNominalZ < 3 && currentRootAmp.watt_2) ampCapacity = currentRootAmp.watt_2;
                else if (systemNominalZ < 6 && currentRootAmp.watt_4) ampCapacity = currentRootAmp.watt_4;
            }

            if (ampCapacity > 0 && totalWatts > (ampCapacity * limits.headroom_warn)) {
                const level = status === 'Error' ? 'Error' : 'Warning';
                status = level;
                statusMsg = 'Low Headroom';
            }
        }

        node.results = {
            minLoad: cMag(cAdd(zEffectiveMin, zTotalCable)),
            nomLoad: cMag(cAdd(zEffectiveNom, zTotalCable)),
            voltageAtSpeaker: tx.voltageAtLoad,
            dropPercent: totalDropPercent,
            powerLoss: tx.powerSource - tx.powerLoad,
            splLoss: electricalLossDb,
            totalDF: totalDF,
            hfLoss: hfCheck,
            status: status,
            statusMessage: statusMsg
        };

        if (node.children) {
            node.children.forEach(child => calcLowZ(child, tx.voltageAtLoad, cumulativeR, safeRootVolts, currentRootAmp));
        }
    };

    // High-V Branch Calculation
    const calcHighV = (node, parentVolts = 100, rootAmpModel = null) => {
        const cable = db.cables[node.cableId];
        const speaker = db.speakers[node.speakerId];

        if (!cable || !speaker) {
            node.results = {
                voltageAtSpeaker: null,
                dropPercent: null,
                dropVolts: null,
                totalPower: null,
                powerLoss: null,
                hfLoss: null,
                status: !speaker ? 'Error' : 'Error',
                statusMessage: !speaker ? 'Speaker Missing' : 'Cable Missing'
            };
            return;
        }

        let currentRootAmp = rootAmpModel;
        if (!node.parentId) {
            currentRootAmp = db.amplifiers[node.ampId];
        }

        const zCable = physics.getCableImpedance(cable, node.length, 1000, state.settings.temp_c);
        const totalP = getTotalPower(node);
        const current = totalP / (parentVolts || 100);
        const dropVolts = current * zCable.magnitude();
        const voltsAtNode = parentVolts - dropVolts;
        const dropPercent = ((100 - voltsAtNode) / 100) * 100;
        const powerLoss = Math.pow(current, 2) * zCable.real;

        let status = 'OK';
        let statusMsg = '';
        if (!node.tapPower || node.tapPower === 0) {
            status = 'Error';
            statusMsg = node.speakerId === 'Default Speaker' ? 'Tap Not Selected' : 'Config Missing';
        } else {
            if (dropPercent > limits.highv_vd_warn) { status = 'Warning'; statusMsg = 'Low V'; }
            if (dropPercent > limits.highv_vd_err) { status = 'Error'; statusMsg = 'Critical V'; }
        }

        // Headroom check
        if (currentRootAmp && !node.parentId) {
            const ampCap = currentRootAmp.watt_100v || currentRootAmp.watt_8;
            if (ampCap > 0 && totalP > (ampCap * limits.headroom_warn)) {
                const level = status === 'Error' ? 'Error' : 'Warning';
                status = level;
                statusMsg = 'Low Headroom';
            }
        }

        const hfCheck = physics.calculateHFLoss(parentVolts, (Math.pow(parentVolts, 2) / (totalP || 1)), cable, node.length, state.settings.temp_c);

        node.results = {
            voltageAtSpeaker: voltsAtNode,
            dropPercent: dropPercent,
            dropVolts: dropVolts,
            totalPower: totalP,
            powerLoss: powerLoss,
            hfLoss: hfCheck,
            status: status,
            statusMessage: statusMsg
        };

        if (node.children) {
            node.children.forEach(child => calcHighV(child, voltsAtNode, currentRootAmp));
        }
    };

    // Execute calculations
    if (state.mode === 'low-z') {
        state.lowZRoots.forEach(n => calcLowZ(n));
    } else {
        state.highVRoots.forEach(n => calcHighV(n));
    }
}
    };

// Create Vue App
const app = createApp({
    setup() {
        const currentView = reactive({ value: 'calculator' });

        onMounted(() => {
            console.log("App Mounted - Manual V3 with Full Physics");
            window.App.Actions.calculateAll();
        });

        const generateReport = () => {
            try {
                // Use form fields instead of prompts
                const company = window.App.State.reportInfo?.company || '';
                const designer = window.App.State.reportInfo?.designer || '';

                const { jsPDF } = window.jspdf;
                const doc = new jsPDF('landscape', 'mm', 'a4');
                const state = window.App.State;
                const profile = window.App.Core.Database.PROFILES[state.qualityMode];

                // Header with dark background
                doc.setFillColor(39, 39, 42);
                doc.rect(0, 0, 297, 35, 'F');

                doc.setFontSize(24);
                doc.setFont('helvetica', 'bold');
                doc.setTextColor(255, 255, 255);
                doc.text('Speaker Design Tool - System Report', 148.5, 15, { align: 'center' });

                doc.setFontSize(9);
                doc.setFont('helvetica', 'normal');
                doc.setTextColor(200, 200, 200);
                doc.text(`Generated: ${new Date().toLocaleString()}`, 148.5, 22, { align: 'center' });

                // Project info
                let y = 30;
                doc.setFontSize(8);
                doc.setTextColor(220, 220, 220);
                if (company) doc.text(`Company: ${company}`, 15, y);
                if (designer) doc.text(`Designer: ${designer}`, company ? 100 : 15, y);

                y = 45;
                doc.setTextColor(255, 255, 255);
                doc.setFontSize(9);
                doc.text(`Project: ${state.projectInfo.name}`, 15, y);
                doc.text(`Mode: ${state.mode === 'low-z' ? 'Low-Z (Direct)' : '100V (Distributed)'}`, 100, y);
                doc.text(`Quality: ${profile.name}`, 170, y);
                doc.text(`Temp: ${state.settings.temp_c}Â°C`, 240, y);

                y += 10;

                // Get all nodes
                const getAllNodes = (nodes) => {
                    let all = [];
                    nodes.forEach(n => {
                        all.push(n);
                        if (n.children) all = all.concat(getAllNodes(n.children));
                    });
                    return all;
                };

                const lowZNodes = getAllNodes(state.lowZRoots);
                const highVNodes = getAllNodes(state.highVRoots);
                const allNodes = [...lowZNodes, ...highVNodes];

                // Summary cards
                const totalNodes = allNodes.length;
                const warnings = allNodes.filter(n => n.results?.status === 'Warning').length;
                const errors = allNodes.filter(n => n.results?.status === 'Error').length;
                const totalPower = highVNodes.reduce((sum, n) => sum + (n.results?.totalPower || 0), 0);

                doc.setFont('helvetica', 'bold');
                doc.setFontSize(10);
                doc.setTextColor(150, 150, 150);
                doc.text('SYSTEM SUMMARY', 15, y);
                y += 8;

                // Summary boxes
                const drawSummaryBox = (x, label, value, color) => {
                    doc.setFillColor(50, 50, 55);
                    doc.roundedRect(x, y, 60, 20, 2, 2, 'F');
                    doc.setFontSize(18);
                    doc.setTextColor(color[0], color[1], color[2]);
                    doc.text(value, x + 30, y + 11, { align: 'center' });
                    doc.setFontSize(7);
                    doc.setTextColor(150, 150, 150);
                    doc.text(label, x + 30, y + 17, { align: 'center' });
                };

                drawSummaryBox(15, 'NODES', `${totalNodes}`, [255, 255, 255]);
                drawSummaryBox(82, 'POWER', `${totalPower.toFixed(0)}W`, [52, 211, 153]);
                drawSummaryBox(149, 'WARNINGS', `${warnings}`, [245, 158, 11]);
                drawSummaryBox(216, 'ERRORS', `${errors}`, [239, 68, 68]);

                y += 30;

                // Low-Z Table
                if (lowZNodes.length > 0) {
                    doc.setFont('helvetica', 'bold');
                    doc.setFontSize(10);
                    doc.setTextColor(150, 150, 150);
                    doc.text('LOW-IMPEDANCE SYSTEM', 15, y);
                    y += 5;

                    const lowZData = lowZNodes.map(n => [
                        n.id,
                        n.userLabel || '-',
                        (state.database.speakers[n.speakerId]?.brand || '') + ' ' + (state.database.speakers[n.speakerId]?.model || 'Unknown'),
                        `${n.length}m`,
                        (n.results?.minLoad?.toFixed(2) || '-') + 'Î©',
                        (n.results?.dropPercent?.toFixed(1) || '-') + '%',
                        n.results?.status || '-'
                    ]);

                    doc.autoTable({
                        startY: y,
                        head: [['ID', 'Label', 'Speaker', 'Cable', 'Load', 'V-Drop', 'Status']],
                        body: lowZData,
                        theme: 'grid',
                        styles: { fontSize: 8, cellPadding: 2, textColor: [200, 200, 200] },
                        headStyles: { fillColor: [52, 211, 153], textColor: [0, 0, 0], fontStyle: 'bold' },
                        alternateRowStyles: { fillColor: [45, 45, 50] },
                        didParseCell: (data) => {
                            if (data.column.index === 6 && data.section === 'body') {
                                const status = data.cell.raw;
                                if (status === 'OK') data.cell.styles.textColor = [52, 211, 153];
                                else if (status === 'Warning') data.cell.styles.textColor = [245, 158, 11];
                                else if (status === 'Error') data.cell.styles.textColor = [239, 68, 68];
                            }
                        }
                    });

                    y = doc.lastAutoTable.finalY + 10;
                }

                // 100V Table
                if (highVNodes.length > 0) {
                    if (y > 160) {
                        doc.addPage();
                        y = 20;
                    }

                    doc.setFont('helvetica', 'bold');
                    doc.setFontSize(10);
                    doc.setTextColor(150, 150, 150);
                    doc.text('100V SYSTEM', 15, y);
                    y += 5;

                    const highVData = highVNodes.map(n => [
                        n.id,
                        n.userLabel || '-',
                        (state.database.speakers[n.speakerId]?.brand || '') + ' ' + (state.database.speakers[n.speakerId]?.model || 'Unknown'),
                        `${n.length}m`,
                        (n.tapPower || '-') + 'W',
                        (n.results?.voltageAtSpeaker?.toFixed(1) || '-') + 'V',
                        n.results?.status || '-'
                    ]);

                    doc.autoTable({
                        startY: y,
                        head: [['ID', 'Label', 'Speaker', 'Cable', 'Tap', 'V @ Speaker', 'Status']],
                        body: highVData,
                        theme: 'grid',
                        styles: { fontSize: 8, cellPadding: 2, textColor: [200, 200, 200] },
                        headStyles: { fillColor: [52, 211, 153], textColor: [0, 0, 0], fontStyle: 'bold' },
                        alternateRowStyles: { fillColor: [45, 45, 50] },
                        didParseCell: (data) => {
                            if (data.column.index === 6 && data.section === 'body') {
                                const status = data.cell.raw;
                                if (status === 'OK') data.cell.styles.textColor = [52, 211, 153];
                                else if (status === 'Warning') data.cell.styles.textColor = [245, 158, 11];
                                else if (status === 'Error') data.cell.styles.textColor = [239, 68, 68];
                            }
                        }
                    });
                }

                // Footer on all pages
                const pageCount = doc.internal.getNumberOfPages();
                for (let i = 1; i <= pageCount; i++) {
                    doc.setPage(i);
                    doc.setFontSize(7);
                    doc.setTextColor(120, 120, 120);
                    doc.text(`Speaker Design Tool v3.0 | Page ${i} of ${pageCount}`, 148.5, 205, { align: 'center' });
                }

                // Save
                const filename = `${state.projectInfo.name.replace(/[^a-z0-9]/gi, '_')}_Report.pdf`;
                doc.save(filename);

                console.log('PDF generated successfully:', filename);
            } catch (error) {
                console.error('PDF Generation Error:', error);
                alert('PDF generation failed: ' + error.message);
            }
        };

        const changeView = (view) => {
            currentView.value = view;
        };

        return {
            state: window.App.State,
            currentView,
            addNode: (id) => window.App.Actions.addNode(id),
            deleteNode: (id) => window.App.Actions.deleteNode(id),
            setMode: (m) => { window.App.State.mode = m; window.App.Actions.calculateAll(); },
            changeView,
            generateReport,
            currentViewComponent: computed(() => {
                if (currentView.value === 'calculator') return 'calculator-view';
                if (currentView.value === 'database') return 'database-view';
                if (currentView.value === 'reports') return 'reports-view';
                if (currentView.value === 'manual') return 'user-manual';
                if (currentView.value === 'techref') return 'tech-reference';
                return 'calculator-view';
            })
        };
    }
});

// Register Components
app.component('app-header', window.App.UI.AppHeader);
app.component('tree-node', window.App.UI.TreeNode);
app.component('user-manual', window.App.UI.UserManual);
app.component('tech-reference', window.App.UI.TechReference);

// Reports View Component (matching v2.6.3)
app.component('reports-view', {
    template: `
            <div class="flex flex-col gap-6 h-full overflow-y-auto animate-in p-6">
                <div class="bg-zinc-800 border border-zinc-700 rounded-lg p-6">
                    <h2 class="text-xl font-bold mb-6 text-white">System Report</h2>
                    
                    <!-- Summary Cards -->
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-8">
                        <div class="p-4 rounded bg-zinc-900 border border-zinc-700">
                            <div class="text-3xl font-bold text-white">{{ reportSummary.totalNodes }}</div>
                            <div class="text-xs uppercase text-zinc-500 font-bold mt-1">Total Nodes</div>
                        </div>
                        <div class="p-4 rounded bg-zinc-900 border border-zinc-700">
                            <div class="text-3xl font-bold text-emerald-400">{{ reportSummary.totalPower.toFixed(0) }} W</div>
                            <div class="text-xs uppercase text-zinc-500 font-bold mt-1">Total Power</div>
                        </div>
                        <div class="p-4 rounded bg-zinc-900 border border-zinc-700">
                            <div class="text-3xl font-bold text-amber-400">{{ reportSummary.warnings }}</div>
                            <div class="text-xs uppercase text-zinc-500 font-bold mt-1">Warnings</div>
                        </div>
                        <div class="p-4 rounded bg-zinc-900 border border-zinc-700">
                            <div class="text-3xl font-bold text-red-400">{{ reportSummary.errors }}</div>
                            <div class="text-xs uppercase text-zinc-500 font-bold mt-1">Errors</div>
                        </div>
                    </div>

                    <!-- Quality Profile Info -->
                    <div class="bg-zinc-900 border border-zinc-700 rounded p-4 mb-8">
                        <h3 class="text-xs uppercase font-bold text-zinc-500 mb-2">Selected Standard: {{ currentProfile.name }}</h3>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 text-sm">
                            <div class="flex items-start gap-2">
                                <span class="px-2 py-1 rounded bg-amber-500/20 text-amber-400 text-xs font-bold">Warning</span>
                                <div class="text-zinc-400 text-xs">
                                    <div><strong>Voltage Drop:</strong> > {{ currentProfile.maxDrop }}% (Low-Z) / {{ currentProfile.maxDrop }}% (100V)</div>
                                    <div><strong>Damping Factor:</strong> < 20</div>
                                </div>
                            </div>
                            <div class="flex items-start gap-2">
                                <span class="px-2 py-1 rounded bg-red-500/20 text-red-400 text-xs font-bold">Error</span>
                                <div class="text-zinc-400 text-xs">
                                    <div><strong>Voltage Drop:</strong> > {{ currentProfile.maxDrop * 1.5 }}%</div>
                                    <div><strong>Damping Factor:</strong> < 10</div>
                                    <div><strong>Low Headroom:</strong> Load > 80% of Amp Capacity</div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Report Generation Form -->
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
                        <div>
                            <label class="text-[10px] font-bold text-zinc-500 uppercase block mb-1">Company Name</label>
                            <input v-model="$root.state.reportInfo.company" class="w-full bg-zinc-900 border border-zinc-700 rounded px-3 py-2 text-sm text-white" placeholder="Your Company Name">
                        </div>
                        <div>
                            <label class="text-[10px] font-bold text-zinc-500 uppercase block mb-1">System Designer</label>
                            <input v-model="$root.state.reportInfo.designer" class="w-full bg-zinc-900 border border-zinc-700 rounded px-3 py-2 text-sm text-white" placeholder="Your Name">
                        </div>
                    </div>
                    
                    <button @click="$root.generateReport()" class="bg-emerald-500 hover:bg-emerald-400 text-black px-6 py-3 rounded font-bold transition-colors flex items-center gap-2">
                        <span class="text-lg">ðŸ“„</span> Generate PDF Report (Landscape)
                    </button>
                </div>

                <!-- Low-Z Breakdown -->
                <div v-if="flatLowZList.length > 0" class="bg-zinc-800 border border-zinc-700 rounded-lg p-6">
                    <h3 class="text-sm font-semibold text-zinc-400 mb-4 uppercase">Low-Impedance Breakdown</h3>
                    <div class="overflow-x-auto">
                        <table class="w-full text-sm">
                            <thead class="bg-zinc-700">
                                <tr class="text-[10px] font-bold text-zinc-400 uppercase">
                                    <th class="px-4 py-3 text-left">ID</th>
                                    <th class="px-4 py-3 text-left">Device</th>
                                    <th class="px-4 py-3 text-left">Cable</th>
                                    <th class="px-4 py-3 text-left">Min Load</th>
                                    <th class="px-4 py-3 text-left">Nom Load</th>
                                    <th class="px-4 py-3 text-left">V Drop</th>
                                    <th class="px-4 py-3 text-left">Loss</th>
                                    <th class="px-4 py-3 text-left">Elec. Loss</th>
                                    <th class="px-4 py-3 text-left">Status</th>
                                </tr>
                            </thead>
                            <tbody class="font-mono">
                                <tr v-for="node in flatLowZList" :key="node.id" class="border-b border-zinc-700 hover:bg-zinc-750">
                                    <td class="px-4 py-3">{{ node.id }}</td>
                                    <td class="px-4 py-3 text-white">{{ getDeviceLabel(node.speakerId) }}</td>
                                    <td class="px-4 py-3 text-xs text-zinc-400">{{ node.length }}m <span v-if="node.length2">+ {{ node.length2 }}m</span></td>
                                    <td class="px-4 py-3">{{ node.results?.minLoad?.toFixed(2) }}Î©</td>
                                    <td class="px-4 py-3">{{ node.results?.nomLoad?.toFixed(2) }}Î©</td>
                                    <td class="px-4 py-3 font-bold">{{ node.results?.dropPercent?.toFixed(2) }}%</td>
                                    <td class="px-4 py-3">{{ node.results?.powerLoss?.toFixed(1) }}W</td>
                                    <td class="px-4 py-3">{{ node.results?.splLoss?.toFixed(2) }}dB</td>
                                    <td class="px-4 py-3">
                                        <span :class="['px-2 py-1 rounded text-xs font-bold', getStatusClass(node.results?.status)]">
                                            {{ node.results?.status }}
                                        </span>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- 100V Breakdown -->
                <div v-if="flatHighVList.length > 0" class="bg-zinc-800 border border-zinc-700 rounded-lg p-6">
                    <h3 class="text-sm font-semibold text-zinc-400 mb-4 uppercase">100V System Breakdown</h3>
                    <div class="overflow-x-auto">
                        <table class="w-full text-sm">
                            <thead class="bg-zinc-700">
                                <tr class="text-[10px] font-bold text-zinc-400 uppercase">
                                    <th class="px-4 py-3 text-left">ID</th>
                                    <th class="px-4 py-3 text-left">Device</th>
                                    <th class="px-4 py-3 text-left">Cable</th>
                                    <th class="px-4 py-3 text-left">Power</th>
                                    <th class="px-4 py-3 text-left">V @ Tap</th>
                                    <th class="px-4 py-3 text-left">Loss</th>
                                    <th class="px-4 py-3 text-left">V @ Speaker</th>
                                    <th class="px-4 py-3 text-left">Status</th>
                                </tr>
                            </thead>
                            <tbody class="font-mono">
                                <tr v-for="node in flatHighVList" :key="node.id" class="border-b border-zinc-700 hover:bg-zinc-750">
                                    <td class="px-4 py-3">{{ node.id }}</td>
                                    <td class="px-4 py-3 text-white">{{ getDeviceLabel(node.speakerId) }}</td>
                                    <td class="px-4 py-3 text-xs text-zinc-400">{{ node.length }}m <span v-if="node.length2">+ {{ node.length2 }}m</span></td>
                                    <td class="px-4 py-3">{{ node.results?.totalPower?.toFixed(1) }}W</td>
                                    <td class="px-4 py-3">{{ node.results?.voltageAtSpeaker?.toFixed(1) }}V</td>
                                    <td class="px-4 py-3">{{ node.results?.powerLoss?.toFixed(1) }}W</td>
                                    <td class="px-4 py-3">{{ node.results?.voltageAtSpeaker?.toFixed(1) }}V</td>
                                    <td class="px-4 py-3">
                                        <span :class="['px-2 py-1 rounded text-xs font-bold', getStatusClass(node.results?.status)]">
                                            {{ node.results?.status }}
                                        </span>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        `,
    computed: {
        reportSummary() {
            const getAllNodes = (nodes) => {
                let all = [];
                nodes.forEach(n => {
                    all.push(n);
                    if (n.children) all = all.concat(getAllNodes(n.children));
                });
                return all;
            };

            const lowZ = getAllNodes(this.$root.state.lowZRoots);
            const highV = getAllNodes(this.$root.state.highVRoots);
            const all = [...lowZ, ...highV];

            return {
                totalNodes: all.length,
                totalPower: highV.reduce((sum, n) => sum + (n.results?.totalPower || 0), 0),
                warnings: all.filter(n => n.results?.status === 'Warning').length,
                errors: all.filter(n => n.results?.status === 'Error').length
            };
        },
        currentProfile() {
            return window.App.Core.Database.PROFILES[this.$root.state.qualityMode];
        },
        flatLowZList() {
            const getAllNodes = (nodes) => {
                let all = [];
                nodes.forEach(n => {
                    all.push(n);
                    if (n.children) all = all.concat(getAllNodes(n.children));
                });
                return all;
            };
            return getAllNodes(this.$root.state.lowZRoots);
        },
        flatHighVList() {
            const getAllNodes = (nodes) => {
                let all = [];
                nodes.forEach(n => {
                    all.push(n);
                    if (n.children) all = all.concat(getAllNodes(n.children));
                });
                return all;
            };
            return getAllNodes(this.$root.state.highVRoots);
        }
    },
    methods: {
        getDeviceLabel(speakerId) {
            const speaker = this.$root.state.database.speakers[speakerId];
            return speaker ? `${speaker.brand} ${speaker.model}` : 'Unknown';
        },
        getStatusClass(status) {
            if (status === 'OK') return 'bg-emerald-500/20 text-emerald-400';
            if (status === 'Warning') return 'bg-amber-500/20 text-amber-400';
            if (status === 'Error') return 'bg-red-500/20 text-red-400';
            return 'bg-zinc-700 text-zinc-400';
        }
    }
});

// Calculator View Component
app.component('calculator-view', {
    template: `
            <div class="flex flex-col gap-6 h-full animate-in">
                <div class="bg-zinc-800 border border-zinc-700 rounded-lg p-5 shrink-0 grid grid-cols-1 lg:grid-cols-[1fr_150px_200px_250px_auto] gap-6 items-end shadow-sm">
                    <div class="space-y-1">
                        <label class="text-[10px] font-bold text-zinc-500 uppercase tracking-wider">Project Name</label>
                        <input v-model="state.projectInfo.name" class="w-full bg-zinc-900 border border-zinc-700 rounded-md px-3 py-2 text-sm text-white focus:border-zinc-500 transition-colors">
                    </div>
                    <div class="space-y-1">
                        <label class="text-[10px] font-bold text-zinc-500 uppercase tracking-wider">Temp</label>
                        <div class="flex items-center bg-zinc-900 border border-zinc-700 rounded-md px-3">
                            <input v-model.number="state.settings.temp_c" type="number" class="w-full bg-transparent border-none py-2 text-sm focus:ring-0 text-center text-white">
                            <span class="text-xs text-zinc-500">Â°C</span>
                        </div>
                    </div>
                    <div class="space-y-1">
                        <label class="text-[10px] font-bold text-zinc-500 uppercase tracking-wider">System Mode</label>
                        <div class="flex bg-zinc-900 rounded-md p-1 border border-zinc-700">
                            <button @click="setMode('low-z')" :class="['flex-1 text-xs font-bold py-1.5 rounded transition-all', state.mode==='low-z'?'bg-zinc-200 text-black shadow-sm':'text-zinc-500 hover:text-white']">Low-Z</button>
                            <button @click="setMode('high-v')" :class="['flex-1 text-xs font-bold py-1.5 rounded transition-all', state.mode==='high-v'?'bg-zinc-200 text-black shadow-sm':'text-zinc-500 hover:text-white']">100V</button>
                        </div>
                    </div>
                    <div class="space-y-1">
                        <label class="text-[10px] font-bold text-zinc-500 uppercase tracking-wider">Standard</label>
                        <div class="flex bg-zinc-900 rounded-md p-1 border border-zinc-700">
                            <button @click="state.qualityMode='high-end'" :class="['flex-1 text-[10px] font-bold py-1.5 rounded px-2 transition-all', state.qualityMode==='high-end'?'bg-emerald-500/20 text-emerald-400 border border-emerald-500/30':'text-zinc-500 hover:text-white']" title="Strict (5%)">Hi-End</button>
                            <button @click="state.qualityMode='average'" :class="['flex-1 text-[10px] font-bold py-1.5 rounded px-2 transition-all', state.qualityMode==='average'?'bg-amber-500/20 text-amber-400 border border-amber-500/30':'text-zinc-500 hover:text-white']" title="Normal (10%)">BGM</button>
                            <button @click="state.qualityMode='speech'" :class="['flex-1 text-[10px] font-bold py-1.5 rounded px-2 transition-all', state.qualityMode==='speech'?'bg-blue-500/20 text-blue-400 border border-blue-500/30':'text-zinc-500 hover:text-white']" title="Relaxed (15%)">Speech</button>
                        </div>
                    </div>
                    <div class="flex justify-end">
                        <button @click="addNode(null)" class="bg-zinc-200 hover:bg-white text-zinc-900 px-5 py-2.5 rounded-md text-sm font-bold transition-colors shadow-sm flex items-center gap-2">
                            <span>+</span> Add New Line
                        </button>
                    </div>
                </div>

                <div class="bg-zinc-800 border border-zinc-700 rounded-lg flex flex-col flex-1 overflow-hidden shadow-lg">
                    <div class="hidden md:grid grid-cols-[80px_1.5fr_2fr_2fr_0.8fr_0.8fr_0.8fr_110px_50px] gap-4 px-4 py-3 bg-zinc-700 text-[10px] font-bold text-zinc-400 uppercase tracking-wider shrink-0 border-b border-zinc-600">
                        <div>ID</div>
                        <div>Label</div>
                        <div>Configuration</div>
                        <div>Cable Run</div>
                        <div>{{state.mode==='low-z'?'Min Load':'Total Power'}}</div>
                        <div>{{state.mode==='low-z'?'Nom Load':'-'}}</div>
                        <div>{{state.mode==='low-z'?'V-Drop %':'V-Drop V'}}</div>
                        <div class="text-center">Status</div>
                        <div></div>
                    </div>
                    <div class="overflow-y-auto flex-1 p-0">
                        <div v-if="(state.mode==='low-z' ? state.lowZRoots : state.highVRoots).length === 0" class="h-full flex flex-col items-center justify-center text-zinc-600 opacity-50">
                            <div class="text-4xl mb-2">âš¡</div>
                            <p>No calculations started.</p>
                        </div>
                        <tree-node v-for="node in (state.mode==='low-z' ? state.lowZRoots : state.highVRoots)" :key="node.id" :node="node" :depth="0" @add-child="addNode" @delete="deleteNode"></tree-node>
                    </div>
                </div>
            </div>
        `,
    inject: ['state', 'addNode', 'deleteNode', 'setMode']
});

// Database View Component
app.component('database-view', {
    template: `
            <div class="flex flex-col gap-6 h-full animate-in">
                <div class="bg-zinc-800 border border-zinc-700 rounded-lg p-5 shrink-0">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-lg font-bold text-white">Equipment Database</h2>
                        <div class="flex gap-2">
                            <button @click="dbTab='speakers'" :class="['px-4 py-2 text-sm font-bold rounded transition-all', dbTab==='speakers'?'bg-emerald-500 text-black':'bg-zinc-700 text-zinc-300 hover:bg-zinc-600']">Speakers</button>
                            <button @click="dbTab='cables'" :class="['px-4 py-2 text-sm font-bold rounded transition-all', dbTab==='cables'?'bg-emerald-500 text-black':'bg-zinc-700 text-zinc-300 hover:bg-zinc-600']">Cables</button>
                            <button @click="dbTab='amplifiers'" :class="['px-4 py-2 text-sm font-bold rounded transition-all', dbTab==='amplifiers'?'bg-emerald-500 text-black':'bg-zinc-700 text-zinc-300 hover:bg-zinc-600']">Amplifiers</button>
                        </div>
                    </div>
                </div>

                <div class="grid grid-cols-1 lg:grid-cols-[350px_1fr] gap-6 flex-1 overflow-hidden">
                    <!-- Left: Add/Edit Form -->
                    <div class="bg-zinc-800 border border-zinc-700 rounded-lg p-5 overflow-y-auto">
                        <h3 class="text-sm font-bold mb-4 text-emerald-400 uppercase">{{ editMode ? 'Edit' : 'Add New' }} {{ dbTab.slice(0,-1) }}</h3>
                        <form @submit.prevent="saveItem" class="space-y-4">
                            <div class="grid grid-cols-2 gap-3">
                                <div>
                                    <label class="text-[10px] font-bold text-zinc-500 uppercase block mb-1">* ID (Unique)</label>
                                    <input v-model="form.id" class="w-full bg-zinc-900 border border-zinc-700 rounded px-3 py-2 text-sm text-white" :disabled="editMode" required>
                                </div>
                                <div>
                                    <label class="text-[10px] font-bold text-zinc-500 uppercase block mb-1">Brand</label>
                                    <input v-model="form.brand" class="w-full bg-zinc-900 border border-zinc-700 rounded px-3 py-2 text-sm text-white">
                                </div>
                            </div>
                            <div>
                                <label class="text-[10px] font-bold text-zinc-500 uppercase block mb-1">Model Name</label>
                                <input v-model="form.model" class="w-full bg-zinc-900 border border-zinc-700 rounded px-3 py-2 text-sm text-white">
                            </div>

                            <!-- Speaker Fields -->
                            <div v-if="dbTab==='speakers'" class="space-y-3">
                                <div class="grid grid-cols-2 gap-3">
                                    <div>
                                        <label class="text-[10px] font-bold text-zinc-500 uppercase block mb-1">Impedance (Î©)</label>
                                        <input v-model.number="form.impedance" type="number" step="0.1" class="w-full bg-zinc-900 border border-zinc-700 rounded px-3 py-2 text-sm text-white">
                                    </div>
                                    <div>
                                        <label class="text-[10px] font-bold text-zinc-500 uppercase block mb-1">Z Min (Î©)</label>
                                        <input v-model.number="form.z_min" type="number" step="0.1" class="w-full bg-zinc-900 border border-zinc-700 rounded px-3 py-2 text-sm text-white">
                                    </div>
                                </div>
                                <div class="grid grid-cols-2 gap-3">
                                    <div>
                                        <label class="text-[10px] font-bold text-zinc-500 uppercase block mb-1">W (RMS)</label>
                                        <input v-model.number="form.wattage_rms" type="number" class="w-full bg-zinc-900 border border-zinc-700 rounded px-3 py-2 text-sm text-white">
                                    </div>
                                    <div>
                                        <label class="text-[10px] font-bold text-zinc-500 uppercase block mb-1">W (Peak)</label>
                                        <input v-model.number="form.wattage_peak" type="number" class="w-full bg-zinc-900 border border-zinc-700 rounded px-3 py-2 text-sm text-white">
                                    </div>
                                </div>
                                <div>
                                    <label class="text-[10px] font-bold text-zinc-500 uppercase block mb-1">100V Taps (W, comma separated)</label>
                                    <input v-model="form.taps" class="w-full bg-zinc-900 border border-zinc-700 rounded px-3 py-2 text-sm text-white" placeholder="e.g. 60,30,15,7.5">
                                </div>
                            </div>

                            <!-- Cable Fields -->
                            <div v-if="dbTab==='cables'" class="space-y-3">
                                <div>
                                    <label class="text-[10px] font-bold text-zinc-500 uppercase block mb-1">Resistance (Î©/km)</label>
                                    <input v-model.number="form.resistance" type="number" step="0.01" class="w-full bg-zinc-900 border border-zinc-700 rounded px-3 py-2 text-sm text-white" required>
                                </div>
                                <div class="grid grid-cols-2 gap-3">
                                    <div>
                                        <label class="text-[10px] font-bold text-zinc-500 uppercase block mb-1">Capacitance (pF/m)</label>
                                        <input v-model.number="form.capacitance" type="number" class="w-full bg-zinc-900 border border-zinc-700 rounded px-3 py-2 text-sm text-white">
                                    </div>
                                    <div>
                                        <label class="text-[10px] font-bold text-zinc-500 uppercase block mb-1">Inductance (ÂµH/m)</label>
                                        <input v-model.number="form.inductance" type="number" step="0.01" class="w-full bg-zinc-900 border border-zinc-700 rounded px-3 py-2 text-sm text-white">
                                    </div>
                                </div>
                            </div>

                            <!-- Amplifier Fields -->
                            <div v-if="dbTab==='amplifiers'" class="space-y-3">
                                <div class="grid grid-cols-2 gap-3">
                                    <div>
                                        <label class="text-[10px] font-bold text-zinc-500 uppercase block mb-1">W (8Î©)</label>
                                        <input v-model.number="form.watt_8" type="number" class="w-full bg-zinc-900 border border-zinc-700 rounded px-3 py-2 text-sm text-white">
                                    </div>
                                    <div>
                                        <label class="text-[10px] font-bold text-zinc-500 uppercase block mb-1">W (4Î©)</label>
                                        <input v-model.number="form.watt_4" type="number" class="w-full bg-zinc-900 border border-zinc-700 rounded px-3 py-2 text-sm text-white">
                                    </div>
                                </div>
                                <div class="grid grid-cols-2 gap-3">
                                    <div>
                                        <label class="text-[10px] font-bold text-zinc-500 uppercase block mb-1">W (Bridge 8Î©)</label>
                                        <input v-model.number="form.watt_bridge_8" type="number" class="w-full bg-zinc-900 border border-zinc-700 rounded px-3 py-2 text-sm text-white">
                                    </div>
                                    <div>
                                        <label class="text-[10px] font-bold text-zinc-500 uppercase block mb-1">W (100V)</label>
                                        <input v-model.number="form.watt_100v" type="number" class="w-full bg-zinc-900 border border-zinc-700 rounded px-3 py-2 text-sm text-white">
                                    </div>
                                </div>
                                <div class="grid grid-cols-2 gap-3">
                                    <div>
                                        <label class="text-[10px] font-bold text-zinc-500 uppercase block mb-1">Damping Factor</label>
                                        <input v-model.number="form.df" type="number" class="w-full bg-zinc-900 border border-zinc-700 rounded px-3 py-2 text-sm text-white">
                                    </div>
                                    <div>
                                        <label class="text-[10px] font-bold text-zinc-500 uppercase block mb-1">Min Load (Î©)</label>
                                        <input v-model.number="form.min_load" type="number" step="0.1" class="w-full bg-zinc-900 border border-zinc-700 rounded px-3 py-2 text-sm text-white">
                                    </div>
                                </div>
                            </div>

                            <div class="flex gap-2 pt-4 border-t border-zinc-700">
                                <button type="submit" class="flex-1 bg-emerald-500 hover:bg-emerald-400 text-black px-4 py-2 rounded font-bold transition-colors">
                                    {{ editMode ? 'Save Changes' : 'Add Item' }}
                                </button>
                                <button v-if="editMode" type="button" @click="cancelEdit" class="px-4 py-2 bg-zinc-700 hover:bg-zinc-600 text-white rounded font-bold transition-colors">
                                    Cancel
                                </button>
                            </div>
                        </form>

                        <div class="mt-6 pt-6 border-t border-zinc-700">
                            <h4 class="text-xs font-bold text-zinc-500 uppercase mb-3">Data Tools</h4>
                            <div class="flex flex-col gap-2">
                                <input type="file" ref="dbImport" @change="handleDbImport" class="hidden" accept=".csv">
                                <button @click="$refs.dbImport.click()" class="px-4 py-2 bg-zinc-700 hover:bg-zinc-600 text-white rounded text-sm font-bold transition-colors">
                                    ðŸ“‚ Import CSV
                                </button>
                                <button @click="exportDbCsv" class="px-4 py-2 bg-zinc-700 hover:bg-zinc-600 text-white rounded text-sm font-bold transition-colors">
                                    ðŸ’¾ Export CSV
                                </button>
                                <button @click="resetDefaults" class="px-4 py-2 bg-red-900 hover:bg-red-800 text-white rounded text-sm font-bold transition-colors">
                                    ðŸ”„ Reset to Defaults
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Right: Data Table -->
                    <div class="bg-zinc-800 border border-zinc-700 rounded-lg overflow-hidden flex flex-col">
                        <div class="overflow-y-auto flex-1">
                            <table class="w-full text-sm">
                                <thead class="bg-zinc-700 sticky top-0">
                                    <tr class="text-[10px] font-bold text-zinc-400 uppercase">
                                        <th class="px-4 py-3 text-left">ID</th>
                                        <th class="px-4 py-3 text-left">Brand</th>
                                        <th class="px-4 py-3 text-left">Model</th>
                                        <th class="px-4 py-3 text-left">Specs</th>
                                        <th class="px-4 py-3 text-center">Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr v-for="item in currentData" :key="item.id" class="border-b border-zinc-700 hover:bg-zinc-750 transition-colors">
                                        <td class="px-4 py-3 font-mono text-xs text-zinc-400">{{ item.id }}</td>
                                        <td class="px-4 py-3 text-white font-medium">{{ item.brand }}</td>
                                        <td class="px-4 py-3 text-zinc-300">{{ item.model || '-' }}</td>
                                        <td class="px-4 py-3 text-xs text-zinc-400">
                                            <span v-if="dbTab==='speakers'">{{ item.impedance }}Î©, {{ item.wattage_rms }}W RMS</span>
                                            <span v-if="dbTab==='cables'">{{ item.resistance }}Î©/km</span>
                                            <span v-if="dbTab==='amplifiers'">{{ item.watt_8 }}W@8Î©, DF:{{ item.df }}</span>
                                        </td>
                                        <td class="px-4 py-3 text-center">
                                            <button @click="editItem(item.id)" class="text-emerald-400 hover:text-emerald-300 px-2 font-bold">âœŽ</button>
                                            <button @click="deleteItem(item.id)" class="text-red-400 hover:text-red-300 px-2 font-bold text-lg">Ã—</button>
                                        </td>
                                    </tr>
                                    <tr v-if="currentData.length === 0">
                                        <td colspan="5" class="px-4 py-12 text-center text-zinc-600">No {{ dbTab }} in database</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        `,
    data() {
        return {
            dbTab: 'speakers',
            editMode: false,
            form: this.getEmptyForm()
        };
    },
    computed: {
        currentData() {
            return Object.values(this.$root.state.database[this.dbTab] || {});
        }
    },
    watch: {
        dbTab() {
            this.cancelEdit();
        }
    },
    methods: {
        getEmptyForm() {
            return {
                id: '',
                brand: '',
                model: '',
                impedance: null,
                z_min: null,
                wattage_rms: null,
                wattage_peak: null,
                taps: '',
                resistance: null,
                capacitance: null,
                inductance: null,
                watt_8: null,
                watt_4: null,
                watt_bridge_8: null,
                watt_100v: null,
                df: null,
                min_load: null
            };
        },
        saveItem() {
            const cleanForm = { ...this.form };
            // Remove null/empty values
            Object.keys(cleanForm).forEach(key => {
                if (cleanForm[key] === null || cleanForm[key] === '') delete cleanForm[key];
            });

            this.$root.state.database[this.dbTab][cleanForm.id] = cleanForm;
            localStorage.setItem('sdt_database_v3', JSON.stringify(this.$root.state.database));
            this.cancelEdit();
        },
        editItem(id) {
            const item = this.$root.state.database[this.dbTab][id];
            this.form = { ...item };
            this.editMode = true;
        },
        deleteItem(id) {
            if (confirm(`Delete ${id}?`)) {
                delete this.$root.state.database[this.dbTab][id];
                localStorage.setItem('sdt_database_v3', JSON.stringify(this.$root.state.database));
            }
        },
        cancelEdit() {
            this.form = this.getEmptyForm();
            this.editMode = false;
        },
        handleDbImport(e) {
            const file = e.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = (evt) => {
                try {
                    const csv = evt.target.result;
                    const parsed = window.App.Utils.IO.parseCSV(csv);
                    if (parsed && parsed.length > 0) {
                        parsed.forEach(item => {
                            if (item.id) {
                                this.$root.state.database[this.dbTab][item.id] = item;
                            }
                        });
                        localStorage.setItem('sdt_database_v3', JSON.stringify(this.$root.state.database));
                        alert(`Imported ${parsed.length} ${this.dbTab}`);
                    }
                } catch (err) {
                    alert('Import failed: ' + err.message);
                }
            };
            reader.readAsText(file);
        },
        exportDbCsv() {
            const data = Object.values(this.$root.state.database[this.dbTab]);
            if (data.length === 0) {
                alert('No data to export');
                return;
            }

            const headers = Object.keys(data[0]);
            const csv = [
                headers.join(','),
                ...data.map(row => headers.map(h => row[h] || '').join(','))
            ].join('\n');

            window.App.Utils.IO.downloadCSV(csv, `${this.dbTab}_export.csv`);
        },
        resetDefaults() {
            if (confirm(`Reset ${this.dbTab} to factory defaults? This cannot be undone.`)) {
                // Clear current data completely
                const defaultData = JSON.parse(JSON.stringify(window.App.Core.Database.DATA[this.dbTab]));

                // Replace the entire object to trigger reactivity
                this.$root.state.database[this.dbTab] = defaultData;

                // Force update and save
                this.$forceUpdate();
                localStorage.setItem('sdt_database_v3', JSON.stringify(this.$root.state.database));

                alert(`${this.dbTab} reset to factory defaults`);
            }
        }
    }
});

// Provide Global State
app.provide('state', window.App.State);
app.provide('addNode', window.App.Actions.addNode);
app.provide('deleteNode', window.App.Actions.deleteNode);
app.provide('setMode', (m) => { window.App.State.mode = m; window.App.Actions.calculateAll(); });

// Mount App
app.mount('#app');
console.log("Vue App Mounted with Full Physics");
}) ();
