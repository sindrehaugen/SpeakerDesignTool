<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Speaker Design Tool v2.3.6</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.23/jspdf.plugin.autotable.min.js"></script>
    
    <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>

    <link rel="stylesheet" href="style.css">
</head>
<body>
    <div id="app" class="app-container" v-cloak>
        <header>
            <div>
                <h1 class="text-2xl font-semibold text-white">Speaker Design Tool <span class="text-sm text-secondary font-normal">{{ APP_VERSION }}</span></h1>
                <p class="text-sm text-secondary">Professional Audio System Calculator</p>
            </div>
            <div class="flex gap-2">
                <button @click="clearCurrentResults" class="btn btn-danger btn-sm">Clear Results</button>
                <button @click="exportProjectCsv" class="btn btn-secondary btn-sm">Save Project</button>
                <button @click="triggerProjectImport" class="btn btn-secondary btn-sm">Open Project</button>
                <input type="file" ref="projectImportInput" class="hidden" accept=".csv" @change="loadProjectCsv">
            </div>
        </header>

        <nav class="nav-bar">
            <button @click="currentView='calculator'" :class="['nav-btn', {active: currentView==='calculator'}]">Calculator</button>
            <button @click="currentView='database'" :class="['nav-btn', {active: currentView==='database'}]">Database</button>
            <button @click="currentView='reports'" :class="['nav-btn', {active: currentView==='reports'}]">Reports</button>
            <button @click="currentView='explanations'" :class="['nav-btn', {active: currentView==='explanations'}]">Technical Reference</button>
            <button @click="currentView='manual'" :class="['nav-btn', {active: currentView==='manual'}]">User Manual</button>
        </nav>

        <div v-if="currentView === 'calculator'">
            <div class="panel mb-4">
                <div class="grid grid-cols-1 md:grid-cols-4 gap-4 items-end">
                    <div>
                        <label class="form-label">Project Name</label>
                        <input v-model="project.name" class="form-input h-[42px] w-full" placeholder="Enter project name...">
                    </div>

                    <div>
                        <label class="form-label">Environment</label>
                        <div class="flex items-center gap-2 bg-bg-app border border-border-subtle p-1 rounded h-[42px] w-full">
                            <label class="text-[10px] text-secondary font-bold uppercase px-2">Temp</label>
                            <input type="number" v-model.number="globalSettings.temp_c" class="form-input w-full text-center !py-1 !h-8 !bg-panel border-none">
                            <span class="text-xs text-secondary pr-2">Â°C</span>
                        </div>
                    </div>

                    <div>
                        <label class="form-label">System Type</label>
                        <div class="flex gap-2 w-full">
                            <button @click="calculatorMode='low-z'" :class="['btn flex-1 h-[42px] font-bold', calculatorMode==='low-z'?'btn-primary':'btn-secondary']">Low-Z</button>
                            <button @click="calculatorMode='high-v'" :class="['btn flex-1 h-[42px] font-bold', calculatorMode==='high-v'?'btn-primary':'btn-secondary']">100V</button>
                        </div>
                    </div>

                    <div>
                        <label class="form-label">Quality Standard</label>
                        <div class="flex gap-2 w-full">
                            <button @click="qualityMode='high-end'" :class="['btn flex-1 h-[42px] font-bold px-1', qualityMode==='high-end'?'btn-primary':'btn-secondary']" title="Strict limits">High-End</button>
                            <button @click="qualityMode='average'" :class="['btn flex-1 h-[42px] font-bold px-1', qualityMode==='average'?'btn-primary':'btn-secondary']" title="Standard limits">Average</button>
                            <button @click="qualityMode='speech'" :class="['btn flex-1 h-[42px] font-bold px-1', qualityMode==='speech'?'btn-primary':'btn-secondary']" title="Relaxed limits">Speech</button>
                        </div>
                    </div>
                </div>
                <div class="mt-2 text-xs text-dim text-right italic">{{ currentProfile.description }} (Warn @ {{currentProfile.thresholds.lowz_vd_warn}}% Drop)</div>
            </div>

            <div class="panel">
                <h3 class="text-sm font-semibold text-accent-primary mb-4 uppercase">
                    Add {{ calculatorMode === 'low-z' ? 'Low-Impedance' : '100V' }} Connection
                </h3>
                <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                    <div class="md:col-span-1">
                        <label class="form-label">Source (Parent)</label>
                        <select v-model="inputForm.parentId" class="form-select mb-2">
                            <option :value="null">Start New Line (Amp)</option>
                            <option v-for="n in activeFlatList" :value="n.id">{{n.id}} ({{ getDeviceLabel('speakers', n.speakerModel) }})</option>
                        </select>
                        <div v-if="!inputForm.parentId" class="p-3 bg-bg-app rounded border border-border-subtle animate-fade-in">
                            <label class="form-label text-[10px] mb-1">Select Amplifier</label>
                            <select v-model="inputForm.ampModel" class="form-select text-xs mb-2">
                                <option value="">-- Select --</option>
                                <option v-for="a in ampOptions" :value="a.id">{{a.label}}</option>
                            </select>
                            <div v-if="calculatorMode === 'low-z'" class="flex items-center gap-2">
                                <input type="checkbox" v-model="inputForm.useBridgeMode" id="bridgeCheck">
                                <label for="bridgeCheck" class="text-xs text-secondary cursor-pointer">Bridge Mode</label>
                            </div>
                        </div>
                    </div>

                    <div class="md:col-span-1">
                        <label class="form-label">Speaker</label>
                        <select v-model="inputForm.speakerModel" class="form-select mb-2">
                            <option value="">-- Select Speaker --</option>
                            <option v-for="s in speakerOptions" :value="s.id">{{s.label}}</option>
                        </select>
                        
                        <div v-if="calculatorMode==='low-z'">
                            <label class="form-label">Quantity (Parallel)</label>
                            <input type="number" v-model.number="inputForm.parallelCount" class="form-input" min="1">
                        </div>
                        <div v-else>
                            <label class="form-label">Power Tap (W)</label>
                            <select v-model.number="inputForm.tapPower" class="form-select">
                                <option v-for="t in getSpeakerTaps(inputForm.speakerModel)" :value="t">{{t}} W</option>
                            </select>
                        </div>
                    </div>

                    <div class="md:col-span-2 grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label class="form-label flex justify-between">Main Cable Run <span class="text-[10px] text-dim lowercase font-normal">length (m)</span></label>
                            <div class="flex gap-1 mb-2">
                                <select v-model="inputForm.cableModel" class="form-select text-xs flex-grow">
                                    <option value="">-- Select Cable --</option>
                                    <option v-for="c in cableOptions" :value="c.id">{{c.label}}</option>
                                </select>
                                <input type="number" v-model.number="inputForm.length" class="form-input w-16 text-center" placeholder="m" min="0">
                            </div>
                        </div>

                        <div class="flex flex-col">
                             <div class="flex justify-between items-center mb-1">
                                <label class="form-label !mb-0">Final Cable (Opt) <span class="text-[10px] text-dim lowercase font-normal">length (m)</span></label>
                                <button @click="inputForm.hasTapCable=!inputForm.hasTapCable" class="text-xs text-status-info hover:underline">
                                    {{inputForm.hasTapCable ? 'Remove' : 'Add'}}
                                </button>
                            </div>
                            <div v-if="inputForm.hasTapCable" class="flex gap-1 animate-fade-in mb-2">
                                <select v-model="inputForm.cableModel2" class="form-select text-xs flex-grow">
                                    <option value="">-- Select Cable --</option>
                                    <option v-for="c in cableOptions" :value="c.id">{{c.label}}</option>
                                </select>
                                <input type="number" v-model.number="inputForm.length2" class="form-input w-16 text-center" placeholder="m" min="0">
                            </div>
                            <button @click="addNode" class="btn btn-primary w-full h-[38px] mt-auto">Add Calculation</button>
                        </div>
                    </div>
                </div>
            </div>

            <div class="panel" style="padding:0; overflow:hidden;">
                <div class="results-header hidden md:grid md:grid-cols-[70px_1.5fr_2fr_2fr_0.7fr_0.7fr_0.7fr_0.7fr_0.7fr_100px_40px] gap-4">
                    <div>ID</div><div>Name</div><div>Details</div><div>Cable</div>
                    <div>{{ calculatorMode === 'low-z' ? 'Min Load (Z)' : 'Total Power' }}</div>
                    <div v-if="calculatorMode === 'low-z'">Nom Load (Z)</div><div v-else class="hidden md:block"></div>
                    <div>{{ calculatorMode === 'low-z' ? 'V Drop %' : 'V Drop V' }}</div><div>Pow Loss</div>
                    <div>{{ calculatorMode === 'low-z' ? 'Elec. Loss' : 'V @ Speaker' }}</div><div>Status</div><div></div>
                </div>
                <div class="tree-container">
                    <tree-node v-for="node in activeRootNodes" :key="node.id" :node="node" :mode="calculatorMode" :get-label="getDeviceLabel" @delete="deleteNode"></tree-node>
                </div>
                <div v-if="activeRootNodes.length===0" class="p-12 text-center text-secondary italic">No {{ calculatorMode === 'low-z' ? 'Low-Impedance' : '100V' }} calculations yet.</div>
            </div>
        </div>

        <div v-if="currentView==='database'" class="panel">
            <div class="flex flex-col md:flex-row justify-between items-center mb-6 border-b border-border-subtle pb-4">
                <h2 class="text-lg font-semibold text-white">Equipment Database</h2>
                <div class="flex gap-2 mt-2 md:mt-0">
                    <button @click="dbTab='speakers'" :class="['btn btn-sm', dbTab==='speakers'?'btn-primary':'btn-secondary']">Speakers</button>
                    <button @click="dbTab='cables'" :class="['btn btn-sm', dbTab==='cables'?'btn-primary':'btn-secondary']">Cables</button>
                    <button @click="dbTab='amplifiers'" :class="['btn btn-sm', dbTab==='amplifiers'?'btn-primary':'btn-secondary']">Amplifiers</button>
                </div>
            </div>
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                <div class="lg:col-span-1 bg-bg-input p-4 rounded border border-border-subtle h-fit">
                    <h3 class="text-sm font-semibold mb-4 text-accent-primary">{{ dbEditMode ? 'Edit' : 'Add New' }} {{ dbTab.slice(0,-1) }}</h3>
                    <form @submit.prevent="saveDbItem" class="space-y-3">
                        <div class="grid grid-cols-2 gap-2">
                            <div><label class="form-label">* ID (Unique)</label><input v-model="dbForm.id" class="form-input" :disabled="dbEditMode" required></div>
                            <div><label class="form-label">Brand</label><input v-model="dbForm.brand" class="form-input"></div>
                        </div>
                        <div><label class="form-label">Model Name</label><input v-model="dbForm.model" class="form-input"></div>

                        <div v-if="dbTab==='speakers'" class="space-y-3 animate-fade-in">
                            <div class="grid grid-cols-2 gap-2"><div><label class="form-label">Impedance (Î©)</label><input v-model.number="dbForm.impedance" type="number" step="0.1" class="form-input"></div><div><label class="form-label">W (RMS)</label><input v-model.number="dbForm.wattage_rms" type="number" class="form-input"></div></div>
                            <div class="grid grid-cols-2 gap-2"><div><label class="form-label">Max SPL (1m)</label><input v-model.number="dbForm.max_spl" type="number" class="form-input"></div><div><label class="form-label">W (Peak)</label><input v-model.number="dbForm.wattage_peak" type="number" class="form-input"></div></div>
                            <div><label class="form-label">100V Taps (comma separated)</label><input v-model="dbForm.taps" class="form-input" placeholder="e.g. 60,30,15"></div>
                            <div><label class="form-label">Category</label><select v-model="dbForm.category" class="form-select"><option value="satellite">Satellite</option><option value="small_fullrange">Small Fullrange</option><option value="large_fullrange">Large Fullrange</option><option value="subwoofer">Subwoofer</option></select></div>
                        </div>
                        <div v-if="dbTab==='cables'" class="space-y-3 animate-fade-in">
                            <div><label class="form-label">Resistance (Î©/km)</label><input v-model.number="dbForm.resistance" type="number" step="0.01" class="form-input" required></div>
                            <div class="grid grid-cols-2 gap-2"><div><label class="form-label">Capacitance (pF/m)</label><input v-model.number="dbForm.capacitance" type="number" class="form-input"></div><div><label class="form-label">Inductance (ÂµH/m)</label><input v-model.number="dbForm.inductance" type="number" step="0.01" class="form-input"></div></div>
                        </div>
                        <div v-if="dbTab==='amplifiers'" class="space-y-3 animate-fade-in">
                            <div class="grid grid-cols-2 gap-2"><div><label class="form-label">W (8Î©)</label><input v-model.number="dbForm.watt_8" type="number" class="form-input"></div><div><label class="form-label">W (4Î©)</label><input v-model.number="dbForm.watt_4" type="number" class="form-input"></div></div>
                            <div><label class="form-label">W (100V)</label><input v-model.number="dbForm.watt_100v" type="number" class="form-input"></div>
                            <div class="grid grid-cols-2 gap-2"><div><label class="form-label">Damping Factor</label><input v-model.number="dbForm.df" type="number" class="form-input"></div><div><label class="form-label">Min Load (Î©)</label><input v-model.number="dbForm.min_load" type="number" step="0.1" class="form-input"></div></div>
                        </div>
                        <div class="flex gap-2 mt-4"><button type="submit" class="btn btn-primary flex-grow">{{ dbEditMode ? 'Save Changes' : 'Add Item' }}</button><button type="button" v-if="dbEditMode" @click="resetDbForm" class="btn btn-secondary">Cancel</button></div>
                    </form>
                    <div class="mt-6 pt-6 border-t border-border-subtle">
                        <h4 class="text-xs font-semibold text-secondary mb-2 uppercase">Data Tools</h4>
                        <div class="flex flex-wrap gap-2"><button @click="triggerDbImport" class="btn btn-sm btn-secondary">Import CSV</button><button @click="exportDbCsv" class="btn btn-sm btn-secondary">Export CSV</button><button @click="resetDbDefaults" class="btn btn-sm btn-danger">Reset Defaults</button></div>
                        <input type="file" ref="dbImportInput" class="hidden" accept=".csv" @change="handleDbImport">
                    </div>
                </div>
                
                <div class="lg:col-span-2 overflow-y-auto max-h-[600px]">
                    <table class="data-table w-full">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Brand</th>
                                <th>Model</th>
                                <th>Specs</th>
                                <th>Action</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr v-for="item in currentDbData" :key="item.id">
                                <td class="font-mono text-secondary text-xs">{{ item.id }}</td>
                                <td class="text-white font-medium">{{ item.brand }}</td>
                                <td class="text-white">{{ item.model || '-' }}</td>
                                <td class="text-xs text-dim">
                                    <span v-if="dbTab==='speakers'">{{item.impedance}}Î©, {{item.wattage_rms}}W</span>
                                    <span v-if="dbTab==='cables'">{{item.resistance}}Î©/km</span>
                                    <span v-if="dbTab==='amplifiers'">{{item.watt_8}}W@8Î©, DF:{{item.df}}</span>
                                </td>
                                <td>
                                    <div class="flex gap-1">
                                        <button @click="editDbItem(item.id)" class="text-status-info hover:text-white px-2">âœŽ</button>
                                        <button @click="deleteDbItem(dbTab, item.id)" class="text-status-danger hover:text-white px-2">&times;</button>
                                    </div>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
        
        <div v-if="currentView==='reports'" class="panel">
            <h2 class="text-xl font-semibold mb-6 text-white">System Report</h2>
            <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-8">
                <div class="p-4 rounded bg-bg-input border border-border-subtle"><div class="text-3xl font-bold text-white">{{ reportSummary.totalNodes }}</div><div class="text-xs uppercase text-secondary font-bold mt-1">Total Nodes</div></div>
                <div class="p-4 rounded bg-bg-input border border-border-subtle"><div class="text-3xl font-bold text-status-ok">{{ reportSummary.totalPower.toFixed(0) }} W</div><div class="text-xs uppercase text-secondary font-bold mt-1">Total Power</div></div>
                <div class="p-4 rounded bg-bg-input border border-border-subtle"><div class="text-3xl font-bold text-status-warn">{{ reportSummary.warnings }}</div><div class="text-xs uppercase text-secondary font-bold mt-1">Warnings</div></div>
                <div class="p-4 rounded bg-bg-input border border-border-subtle"><div class="text-3xl font-bold text-status-danger">{{ reportSummary.errors }}</div><div class="text-xs uppercase text-secondary font-bold mt-1">Errors</div></div>
            </div>
            
            <div class="bg-bg-input border border-border-subtle rounded p-4 mb-8">
                <h3 class="text-xs uppercase font-bold text-muted mb-2">Selected Standard: {{ currentProfile.label }}</h3>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 text-sm">
                    <div class="flex items-start gap-2">
                        <span class="badge badge-warn mt-1">Warning</span>
                        <div class="text-secondary text-xs">
                            <div><strong>Voltage Drop:</strong> > {{currentProfile.thresholds.lowz_vd_warn}}% (Low-Z) / {{currentProfile.thresholds.highv_vd_warn}}% (100V)</div>
                            <div><strong>Damping Factor:</strong> < {{currentProfile.thresholds.df_warn}}</div>
                        </div>
                    </div>
                    <div class="flex items-start gap-2">
                        <span class="badge badge-danger mt-1">Error</span>
                        <div class="text-secondary text-xs">
                            <div><strong>Voltage Drop:</strong> > {{currentProfile.thresholds.lowz_vd_err}}% (Low-Z) / {{currentProfile.thresholds.highv_vd_err}}% (100V)</div>
                            <div><strong>Damping Factor:</strong> < {{currentProfile.thresholds.df_err}}</div>
                            <div><strong>Low Headroom:</strong> Load > {{currentProfile.thresholds.headroom_warn * 100}}% of Amp Capacity</div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
                <div><label class="form-label">Company Name</label><input v-model="reportForm.company" class="form-input" placeholder="Your Company Name"></div>
                <div><label class="form-label">System Designer</label><input v-model="reportForm.designer" class="form-input" placeholder="Your Name"></div>
            </div>
            <button @click="generatePdf" class="btn btn-primary w-full md:w-auto flex items-center justify-center gap-2"><span class="text-lg">ðŸ“„</span> Generate PDF Report (Landscape)</button>
            
            <div class="mt-8 pt-6 border-t border-border-subtle space-y-8">
                 <div v-if="flatLowZList.length > 0">
                     <h3 class="text-sm font-semibold text-secondary mb-4 uppercase">Low-Impedance Breakdown</h3>
                     <div class="overflow-x-auto">
                        <table class="data-table w-full text-sm">
                            <thead><tr><th>ID</th><th>Device</th><th>Cable</th><th>Min Load</th><th>Nom Load</th><th>V Drop</th><th>Loss</th><th>Elec. Loss</th><th>Status</th></tr></thead>
                            <tbody class="font-mono">
                                <tr v-for="node in flatLowZList" :key="node.id">
                                    <td>{{ node.id }}</td><td>{{ getDeviceLabel('speakers', node.speakerModel) }}</td>
                                    <td class="text-xs text-secondary">{{ node.length }}m <span v-if="node.length2">+ {{ node.length2 }}m</span></td>
                                    <td>{{ node.results?.minLoad?.toFixed(2) }}Î©</td><td>{{ node.results?.nomLoad?.toFixed(2) }}Î©</td>
                                    <td>{{ node.results?.dropPercent?.toFixed(2) }}%</td><td>{{ node.results?.powerLoss?.toFixed(1) }}W</td><td>{{ node.results?.splLoss?.toFixed(2) }}dB</td>
                                    <td><span :class="['badge', getStatusClass(node.results?.status)]">{{ node.results?.status }}</span></td>
                                </tr>
                            </tbody>
                        </table>
                     </div>
                 </div>
                 <div v-if="flatHighVList.length > 0">
                     <h3 class="text-sm font-semibold text-secondary mb-4 uppercase">100V System Breakdown</h3>
                     <div class="overflow-x-auto">
                        <table class="data-table w-full text-sm">
                            <thead><tr><th>ID</th><th>Device</th><th>Cable</th><th>Power</th><th>V @ Tap</th><th>Loss</th><th>V @ Speaker</th><th>Status</th></tr></thead>
                            <tbody class="font-mono">
                                <tr v-for="node in flatHighVList" :key="node.id">
                                    <td>{{ node.id }}</td><td>{{ getDeviceLabel('speakers', node.speakerModel) }}</td>
                                    <td class="text-xs text-secondary">{{ node.length }}m <span v-if="node.length2">+ {{ node.length2 }}m</span></td>
                                    <td>{{ node.results?.totalPower?.toFixed(1) }}W</td><td>{{ node.results?.voltageAtSpeaker?.toFixed(1) }}V</td>
                                    <td>{{ node.results?.powerLoss?.toFixed(1) }}W</td><td>{{ node.results?.voltageAtSpeaker?.toFixed(1) }}V</td>
                                    <td><span :class="['badge', getStatusClass(node.results?.status)]">{{ node.results?.status }}</span></td>
                                </tr>
                            </tbody>
                        </table>
                     </div>
                 </div>
            </div>
        </div>

        <div v-if="currentView==='explanations'" class="panel">
            <div class="prose mx-auto max-w-5xl">
                <h2 class="text-3xl font-bold mb-8 text-white border-b border-border-subtle pb-4">Technical Reference Manual</h2>
                
                <section class="mb-12">
                    <h3 class="text-2xl font-semibold mb-6 text-accent-primary">1. Quality Standards & Profiles</h3>
                    <p class="mb-4">This tool uses predefined profiles derived from international standards (IEC 60268-3, AES2-2012) to evaluate system performance. Choosing the correct profile is critical for balancing cost vs. audio quality.</p>
                    
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mt-6">
                        <div class="bg-bg-input p-6 rounded border-t-4 border-accent-primary">
                            <h4 class="text-lg font-bold mb-2 text-white">High-End / Reference</h4>
                            <p class="text-sm text-secondary mb-4"><strong>Target:</strong> Concert Touring, Recording Studios, Cinemas, Critical Listening.</p>
                            <div class="text-xs text-dim space-y-2">
                                <p><strong>Goal:</strong> Total transparency. The cable must behave as an "invisible link".</p>
                                <ul class="list-disc pl-4">
                                    <li><strong>Voltage Drop:</strong> &lt; 5% (-0.42 dB). Keeps dynamics intact.</li>
                                    <li><strong>Damping Factor:</strong> &gt; 20. Required for tight, punchy sub-bass.</li>
                                    <li><strong>HF Loss:</strong> Calculated at 10kHz to ensure "air" and brilliance.</li>
                                </ul>
                            </div>
                        </div>
                        <div class="bg-bg-input p-6 rounded border-t-4 border-gray-500">
                            <h4 class="text-lg font-bold mb-2 text-white">Commercial / BGM</h4>
                            <p class="text-sm text-secondary mb-4"><strong>Target:</strong> Retail, Restaurants, Corporate Offices, Background Music.</p>
                            <div class="text-xs text-dim space-y-2">
                                <p><strong>Goal:</strong> Cost-efficiency. Minor dynamic loss is acceptable as music is background.</p>
                                <ul class="list-disc pl-4">
                                    <li><strong>Voltage Drop:</strong> &lt; 10% (-0.92 dB). Audible but acceptable compression.</li>
                                    <li><strong>Damping Factor:</strong> &gt; 10. Sufficient for full-range ceiling speakers.</li>
                                    <li><strong>HF Loss:</strong> Calculated at 6kHz.</li>
                                </ul>
                            </div>
                        </div>
                        <div class="bg-bg-input p-6 rounded border-t-4 border-gray-600">
                            <h4 class="text-lg font-bold mb-2 text-white">Speech Only</h4>
                            <p class="text-sm text-secondary mb-4"><strong>Target:</strong> Paging, Voice Evacuation (EN54-16), Warehouses.</p>
                            <div class="text-xs text-dim space-y-2">
                                <p><strong>Goal:</strong> Intelligibility. Mid-range clarity (500Hz-4kHz) is king; voltage drop mainly affects volume.</p>
                                <ul class="list-disc pl-4">
                                    <li><strong>Voltage Drop:</strong> &lt; 15-25%. High loss permitted if SPL remains sufficient.</li>
                                    <li><strong>Damping Factor:</strong> &gt; 5. Bass control is irrelevant.</li>
                                    <li><strong>HF Loss:</strong> Calculated at 4kHz (Voice band presence).</li>
                                </ul>
                            </div>
                        </div>
                    </div>
                </section>

                <section class="mb-12">
                    <h3 class="text-2xl font-semibold mb-6 text-accent-primary">2. Electrical Physics & Formulas</h3>
                    <p class="mb-6">The calculation engine does not use simple DC resistance checks. It models the entire signal chain using <strong>Complex Impedance</strong> vectors to account for phase shifts and reactive loads.</p>

                    <div class="space-y-8">
                        <div class="bg-bg-input p-6 rounded">
                            <h4 class="text-lg font-bold text-white mb-2">A. Thermal Derating (Real-World Resistance)</h4>
                            <p class="text-sm text-secondary mb-3">Copper resistance rises significantly with temperature (approx 0.4% per Â°C). A cable that passes inspection at 20Â°C may fail in a hot ceiling void (40Â°C).</p>
                            <div class="formula-box">
                                $$ R_{hot} = R_{20} \cdot [1 + \alpha_{Cu} \cdot (T_{amb} - 20)] $$
                            </div>
                            <p class="text-xs text-dim mt-2">Where \( \alpha_{Cu} = 0.00393 \) (Temperature coefficient of copper).</p>
                        </div>

                        <div class="bg-bg-input p-6 rounded">
                            <h4 class="text-lg font-bold text-white mb-2">B. Cable Impedance Vector</h4>
                            <p class="text-sm text-secondary mb-3">Cables have both Resistance (\(R\)) and Inductance (\(L\)). At audio frequencies, Inductance creates Reactance (\(X_L\)), which opposes current flow. The total impedance \(Z\) is a complex number.</p>
                            <div class="formula-box">
                                $$ Z_{cable} = R_{hot} + j(2\pi \cdot f \cdot L_{cable}) $$
                            </div>
                            <p class="text-xs text-dim mt-2">Standard calculation frequency is 1kHz. High-End checks also run this at 10kHz.</p>
                        </div>

                        <div class="bg-bg-input p-6 rounded">
                            <h4 class="text-lg font-bold text-white mb-2">C. Transmission Line (Voltage Drop)</h4>
                            <p class="text-sm text-secondary mb-3">We treat the system as a potential divider circuit using complex math to account for the phase angle difference between the resistive load (Speaker) and the inductive cable.</p>
                            <div class="formula-box">
                                $$ V_{load} = V_{source} \cdot \left| \frac{Z_{load}}{Z_{load} + Z_{cable}} \right| $$
                            </div>
                            <p class="text-xs text-dim mt-2">Note: Simple \(IR\) drop calculations often overestimate loss because they ignore phase.</p>
                        </div>
                    </div>
                </section>

                <section class="mb-12">
                    <h3 class="text-2xl font-semibold mb-6 text-accent-primary">3. Audio Impact Analysis</h3>
                    
                    <div class="space-y-6">
                        <div class="border-l-4 border-status-warn pl-4">
                            <h4 class="text-lg font-bold text-white">Why Voltage Drop Sounds Like "Compression"</h4>
                            <p class="text-sm text-secondary mt-1">When a subwoofer hits a transient (kick drum), it draws a massive current spike. If the cable resistance is high, the voltage at the speaker terminals sags instantly during that spike ($V = I \cdot R$). This "softens" the impact, making the system sound weak or "compressed," effectively reducing the crest factor of the audio signal. This is a non-linear dynamic loss that cannot be fixed with static EQ.</p>
                        </div>

                        <div class="border-l-4 border-status-info pl-4">
                            <h4 class="text-lg font-bold text-white">Damping Factor & "Muddy" Bass</h4>
                            <p class="text-sm text-secondary mt-1">Damping Factor (DF) is the amplifier's ability to control the speaker cone's motion. After a bass note stops, the heavy cone wants to keep moving due to inertia, generating back-EMF (acting as a generator). A high DF means low source impedance, which short-circuits this back-EMF, applying an electrical brake to stop the cone instantly. High cable resistance destroys this braking effect, leaving the cone to "wobble" after the note, resulting in undefined, muddy low-end (poor transient response).</p>
                            <div class="formula-box mt-2 w-fit">
                                $$ DF_{total} = \frac{Z_{speaker}}{Z_{amp\_output} + R_{cable\_total}} $$
                            </div>
                        </div>

                        <div class="border-l-4 border-accent-primary pl-4">
                            <h4 class="text-lg font-bold text-white">HF Loss (The Low-Pass Filter)</h4>
                            <p class="text-sm text-secondary mt-1">Every cable has capacitance (parallel) and inductance (series). Together with the load impedance, they form a 2nd-order Low-Pass Filter (LCR circuit). Long runs of high-capacitance cable will attenuate high frequencies (10kHz+) significantly more than low frequencies, leading to a "dull" sound and reducing the air/presence of a mix.</p>
                        </div>
                    </div>
                </section>

                <section class="mb-12">
                    <h3 class="text-2xl font-semibold mb-6 text-accent-primary">4. Equipment Health & Safety</h3>
                    <ul class="space-y-4 text-sm text-secondary">
                        <li>
                            <strong class="text-white block mb-1">Transformer Saturation (100V Systems):</strong>
                            In 100V lines, voltage drop is not just about volume. Step-down transformers on speakers are designed for a specific primary voltage. If the line voltage sags significantly (e.g., < 90V), the transformer core may saturate, especially at low frequencies. This causes a spike in distortion (odd-order harmonics) and causes the transformer to heat up, potentially leading to failure.
                        </li>
                        <li>
                            <strong class="text-white block mb-1">Amplifier Stability (Low-Z):</strong>
                            The tool calculates <strong>Min Load (Z)</strong>. Running an amplifier below its rated minimum impedance (e.g., 2Î© load on a 4Î© amp) causes excessive current draw. This overheats the output transistors and can trigger the amplifier's protection circuits (thermal shutdown or current limiting), causing the audio to cut out during loud passages.
                        </li>
                        <li>
                            <strong class="text-white block mb-1">Power Compression (Thermal):</strong>
                            As voice coils heat up during operation, their resistance increases (Power Compression). While this tool models cable thermal rise, remember that the speaker itself loses 3-6dB of efficiency at max power due to voice coil heating. Minimizing cable loss ensures you aren't compounding this efficiency loss.
                        </li>
                    </ul>
                </section>
            </div>
        </div>

        <div v-if="currentView==='manual'" class="panel">
            <div class="prose mx-auto max-w-4xl">
                <h2 class="text-3xl font-bold mb-8 text-white border-b border-border-subtle pb-4">User Manual & Workflow Guide</h2>
                
                <div class="space-y-12">
                    
                    <section>
                        <h3 class="text-2xl font-semibold text-accent-primary mb-4">1. Interface Overview</h3>
                        <p class="mb-4">The Speaker Design Tool is divided into five main sections, accessible via the navigation tabs:</p>
                        <ul class="list-disc pl-5 space-y-2 text-sm text-secondary">
                            <li><strong>Calculator:</strong> The main workspace where you build your system tree and view real-time analysis.</li>
                            <li><strong>Database:</strong> Manage your inventory of Amplifiers, Speakers, and Cables. You can manually edit items or import/export CSV lists.</li>
                            <li><strong>Reports:</strong> View a summarized Bill of Materials (BOM) and generate professional PDF reports for clients.</li>
                            <li><strong>Technical Reference:</strong> A deep dive into the physics, formulas, and standards used by the engine.</li>
                            <li><strong>User Manual:</strong> This guide.</li>
                        </ul>
                    </section>

                    <section>
                        <h3 class="text-2xl font-semibold text-accent-primary mb-4">2. Project Configuration</h3>
                        <div class="bg-bg-input p-6 rounded border-l-4 border-accent-primary space-y-4">
                            <div>
                                <h4 class="text-white font-bold">A. Environment (Temperature)</h4>
                                <p class="text-sm">Copper resistance increases by ~0.4% for every degree Celsius. <strong>Always set this to the maximum expected temperature.</strong> For example, if cables run through a hot ceiling void that reaches 40Â°C in summer, set this to 40. Designing at 20Â°C may lead to system failure in real-world conditions.</p>
                            </div>
                            <div>
                                <h4 class="text-white font-bold">B. System Type (Low-Z vs 100V)</h4>
                                <p class="text-sm">Toggle between <strong>Low-Z</strong> (Standard 4/8/16Î©) and <strong>100V</strong> (High-Impedance/Distributed). The calculator adapts its warning logic based on this selection.</p>
                            </div>
                            <div>
                                <h4 class="text-white font-bold">C. Quality Standard</h4>
                                <p class="text-sm">Select the profile that matches your client's expectations. <strong>High-End</strong> is strict (Music/Performance), while <strong>Speech</strong> is lenient (Paging/Evac). See the <em>Technical Reference</em> tab for exact thresholds.</p>
                            </div>
                        </div>
                    </section>

                    <section>
                        <h3 class="text-2xl font-semibold text-accent-primary mb-4">3. Building Your System</h3>
                        <ol class="list-decimal pl-5 space-y-4 text-sm text-secondary">
                            <li>
                                <strong>Start with an Amplifier:</strong> 
                                Leave the "Source (Parent)" dropdown as <em>Start New Line (Amp)</em>. Select your amplifier model from the list. 
                                <br><em class="text-xs text-dim">Tip: In Low-Z mode, you can enable "Bridge Mode" to use the amplifier's bridged power rating.</em>
                            </li>
                            <li>
                                <strong>Add a Speaker Load:</strong> 
                                Select your Speaker Model and Cable.
                                <ul class="list-disc pl-5 mt-1 text-xs text-dim">
                                    <li><strong>Low-Z:</strong> Enter the number of speakers in parallel (e.g., "2" for two 8Î© speakers = 4Î© load).</li>
                                    <li><strong>100V:</strong> Select the Power Tap wattage.</li>
                                </ul>
                            </li>
                            <li>
                                <strong>Daisy Chaining:</strong> 
                                To simulate a daisy chain, add a <strong>new calculation</strong> row. In the "Source (Parent)" dropdown, select the speaker you just added. This calculates the voltage drop cumulatively from the previous point in the chain.
                            </li>
                            <li>
                                <strong>Analyze Results:</strong> 
                                Watch the status badges on the right.
                                <br><span class="badge badge-ok">OK</span> Design is safe and meets standards.
                                <br><span class="badge badge-warn">Warning</span> Performance is compromised (e.g., audible compression).
                                <br><span class="badge badge-danger">Error</span> Critical failure (e.g., Amp overload, fire hazard, severe distortion).
                            </li>
                        </ol>
                    </section>

                    <section>
                        <h3 class="text-2xl font-semibold text-accent-primary mb-4">4. Database Management</h3>
                        <p class="mb-4 text-sm">The tool stores all device data locally in your browser. You can add custom devices in the <strong>Database</strong> tab.</p>
                        
                        <h4 class="text-white font-bold mb-2">CSV Import/Export</h4>
                        <p class="text-sm mb-2">You can bulk-edit your inventory using CSV files (Excel/Google Sheets). When importing:</p>
                        <ul class="list-disc pl-5 space-y-1 text-sm text-dim">
                            <li><strong>Structure:</strong> It is best to Export the current database first to get a template.</li>
                            <li><strong>Unique IDs:</strong> Each device must have a unique ID (e.g., '1001', 'MySpeaker1'). If you import a row with an existing ID, it will overwrite the old data.</li>
                            <li><strong>Smart Alignment:</strong> The importer automatically handles tricky data (like unquoted speaker taps containing commas) by scanning for keywords like "Lo-Z" or "100V".</li>
                        </ul>
                    </section>

                    <section>
                        <h3 class="text-2xl font-semibold text-accent-primary mb-4">5. Saving & Smart Project Recovery</h3>
                        <p class="mb-4 text-sm">Projects are saved as CSV files containing both the calculation tree and the specific device data used.</p>
                        
                        <div class="bg-bg-input p-6 rounded border border-border-subtle">
                            <h4 class="text-white font-bold mb-2">What happens if I open a project on another computer?</h4>
                            <p class="text-sm mb-3">The tool uses a **Smart Import System** to link your project file to the local database:</p>
                            <ol class="list-decimal pl-5 space-y-2 text-sm text-secondary">
                                <li>It first looks for an exact **ID Match** in your database.</li>
                                <li>If the ID is missing (or from a different user), it searches for a **Brand + Model Name** match.</li>
                                <li>If it finds a potential match (e.g., ID '1001' vs 'Spk_1001'), it will ask you: <em>"Found matching product... Map to this device?"</em></li>
                                <li>If no match is found, it skips that line to prevent errors.</li>
                            </ol>
                        </div>
                    </section>

                </div>
            </div>
        </div>
    </div>

    <script type="text/x-template" id="tree-node-template">
        <div class="node-wrapper animate-fade-in">
            <div class="node-row grid grid-cols-1 md:grid-cols-[70px_1.5fr_2fr_2fr_0.7fr_0.7fr_0.7fr_0.7fr_0.7fr_100px_40px] gap-2 md:gap-4 items-center p-3 border-b border-border-subtle hover:bg-bg-input transition-colors">
                <div class="text-mono text-secondary font-bold">{{node.id}}</div>
                <div><input v-model="node.userLabel" class="table-input" placeholder="Name..."></div>
                <div><div class="text-primary font-medium text-sm">{{ getLabel('speakers', node.speakerModel) }}</div><div class="text-dim text-xs"><span v-if="!node.parentId">Source: {{ getLabel('amplifiers', node.ampModel) }}</span><span v-else>Source: {{node.parentId}}</span><span class="mx-1">|</span>{{mode==='low-z' ? node.parallelCount+'x Parallel' : node.tapPower+'W Tap'}}</div></div>
                <div class="text-mono text-xs text-secondary"><div>{{ getLabel('cables', node.cableModel) }} ({{node.length}}m)</div><div v-if="node.cableModel2">+ {{ getLabel('cables', node.cableModel2) }} ({{node.length2}}m)</div></div>
                <div class="text-mono text-sm"><span class="md:hidden text-xs text-dim mr-2">{{ mode==='low-z'?'Min Z':'Power'}}:</span>{{ mode==='low-z' ? node.results?.minLoad?.toFixed(2) + 'Î©' : node.results?.totalPower?.toFixed(1) + 'W' }}</div>
                <div class="text-mono text-sm"><span class="md:hidden text-xs text-dim mr-2">Nom Z:</span><span v-if="mode==='low-z'">{{ node.results?.nomLoad?.toFixed(2) }}Î©</span><span v-else class="text-dim">-</span></div>
                <div :class="['text-mono font-bold text-sm', getStatusClass(node.results?.status)]"><span class="md:hidden text-xs text-dim mr-2">Drop:</span><span v-if="mode==='low-z'">{{node.results?.dropPercent?.toFixed(2)}}%</span><span v-else>{{(node.results?.dropVolts || 0).toFixed(1)}} V</span></div>
                <div class="text-mono text-secondary text-sm"><span class="md:hidden text-xs text-dim mr-2">Loss:</span>{{node.results?.powerLoss?.toFixed(1)}}W</div>
                <div class="text-mono text-sm"><span class="md:hidden text-xs text-dim mr-2">Out/Loss:</span><div v-if="mode==='low-z'">{{node.results?.splLoss?.toFixed(2)}}dB</div><div v-else>{{node.results?.voltageAtSpeaker?.toFixed(1)}}V</div></div>
                <div class="flex flex-col justify-center md:block text-center">
                    <span :class="['badge', getStatusClass(node.results?.status)]">{{node.results?.status}}</span>
                    <div v-if="node.results?.status !== 'OK' && node.results?.statusMessage" class="text-[10px] mt-1 text-status-danger font-medium uppercase tracking-wide">{{ node.results.statusMessage.replace('Hazard:', '').replace('Warning:', '').replace('Hazard', 'Error') }}</div>
                </div>
                <div class="text-right"><button @click="$emit('delete', node.id)" class="text-status-danger hover:text-white font-bold px-2 text-lg">&times;</button></div>
            </div>
            <div v-if="node.children && node.children.length" class="node-child-container border-l border-border-subtle ml-4 md:ml-6 pl-2">
                <tree-node v-for="c in node.children" :key="c.id" :node="c" :mode="mode" :get-label="getLabel" @delete="$emit('delete', $event)"></tree-node>
            </div>
        </div>
    </script>
    
    <footer class="app-footer">
        <div class="mb-2">App Admin: Sindre LÃ¸vlie Haugen | Source Code: <a href="https://github.com/sindrehaugen/SpeakerDesignTool" target="_blank">GitHub</a> | LinkedIn: <a href="https://www.linkedin.com/in/sindrelhaugen/" target="_blank">linkedin.com/in/sindrelhaugen</a></div>
        <div class="text-[0.65rem] text-dim opacity-70">This program is free software: you can redistribute it and/or modify it under the terms of the GNU General Public License as published by the Free Software Foundation, either version 3 of the License, or (at your option) any later version. This program is distributed in the hope that it will be useful, but WITHOUT ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the GNU General Public License for more details.</div>
    </footer>

    <script src="database.js"></script><script src="physics.js"></script><script src="app.js"></script>
</body>
</html>
